---
- name: Install csctl and csctl-openstack
  vars:
    csctl_dir: "{{ ansible_user_dir }}/csctl"
    csctl_openstack_dir: "{{ ansible_user_dir }}/csctl-openstack"
    # FIXME: Workaround until the csctl binary can be built from the main branch again
    csctl_version: "8549aad57a30b3ea82a0c32f586bd213de60dfa6"
    csctl_openstack_version: "main"
    install_dir: "{{ ansible_user_dir }}/.local/bin"
  block:
    - name: Clone csctl repository
      ansible.builtin.git:
        repo: https://github.com/SovereignCloudStack/csctl.git
        dest: "{{ csctl_dir }}"
        single_branch: true
        version: "{{ csctl_version }}"
    - name: Clone csctl-openstack repository
      ansible.builtin.git:
        repo: https://github.com/SovereignCloudStack/csctl-plugin-openstack.git
        dest: "{{ csctl_openstack_dir }}"
        single_branch: true
        version: "{{ csctl_openstack_version }}"
    - name: Build csctl
      ansible.builtin.command: "make build"
      args:
        chdir: "{{ csctl_dir }}"
      environment:
        PATH: "{{ ansible_env.PATH }}:/usr/local/go/bin"
      changed_when: true
    - name: Build csctl-openstack plugin
      ansible.builtin.command: "make build"
      args:
        chdir: "{{ csctl_openstack_dir }}"
      environment:
        PATH: "{{ ansible_env.PATH }}:/usr/local/go/bin"
      changed_when: true
    - name: Install csctl
      ansible.builtin.copy:
        src: "{{ csctl_dir }}/csctl"
        dest: "{{ install_dir }}/csctl"
        mode: "+x"
        remote_src: true
    - name: Install csctl-openstack
      ansible.builtin.copy:
        src: "{{ csctl_openstack_dir }}/csctl-openstack"
        dest: "{{ install_dir }}/csctl-openstack"
        mode: "+x"
        remote_src: true
