---
- name: Execute sonobouy check mode {{ sonobouy.mode }}
  vars:
    sonobuoy_version: "0.57.1"
    install_dir: "{{ ansible_user_dir }}/.local/bin"
  block:
  - name: Install Sonobuoy
    ansible.builtin.unarchive:
      src: "https://github.com/vmware-tanzu/sonobuoy/releases/download/v{{ sonobuoy_version }}/sonobuoy_{{ sonobuoy_version }}_linux_amd64.tar.gz"
      dest: "{{ install_dir }}"
      mode: '+x'
      remote_src: true
    args:
      creates: "{{ install_dir }}/sonobuoy"
  - name: Run Sonobuoy tests
    ansible.builtin.command: "sonobuoy run --plugin-env=e2e.E2E_PROVIDER=openstack --mode={{ sonobouy.mode }}"
    environment:
      KUBECONFIG: "{{ cluster_manifest_dir }}/kubeconfig-test-cluster"
    changed_when: true
  - name: Wait for Sonobuoy tests to complete
    ansible.builtin.shell:
      cmd: |
        set -o pipefail
        until sonobuoy status | grep "has completed" >/dev/null 2>&1; do
          sleep 10
          sonobuoy status
        done
      executable: /bin/bash
    environment:
      KUBECONFIG: "{{ cluster_manifest_dir }}/kubeconfig-test-cluster"
    changed_when: true
  - name: Sonobuoy status
    ansible.builtin.command: "sonobuoy status"
    environment:
      KUBECONFIG: "{{ cluster_manifest_dir }}/kubeconfig-test-cluster"
    register: sonobuoy_status
    changed_when: true
  - name: Retrieve Sonobuoy results
    ansible.builtin.command: "sonobuoy retrieve"
    environment:
      KUBECONFIG: "{{ cluster_manifest_dir }}/kubeconfig-test-cluster"
    register: sonobuoy_retrieve_output
    changed_when: true
  - name: Get Sonobuoy results
    ansible.builtin.command: "sonobuoy results {{ sonobuoy_retrieve_output.stdout }}"
    environment:
      KUBECONFIG: "{{ cluster_manifest_dir }}/kubeconfig-test-cluster"
    register: sonobouy_results
    changed_when: true
  - name: Delete k8s resources that were generated by a Sonobuoy run
    ansible.builtin.command: "sonobuoy delete --all"
    environment:
      KUBECONFIG: "{{ cluster_manifest_dir }}/kubeconfig-test-cluster"
    changed_when: true
  - name: Remove Sonobuoy retrieve file
    ansible.builtin.file:
      path: "{{ sonobuoy_retrieve_output.stdout }}"
      state: absent
  - name: Insert sonobouy results to the warning message that will be appended to the comment zuul leaves on the PR  # noqa: ignore-errors
    zuul_return:
      data:
        zuul:
          warnings:
            - "<details>\n  <summary><b>Sonobouy results</b></summary>\n{{ sonobouy_results.stdout }}\n</details>"
    when: sonobouy_results is defined and sonobouy_results | length > 0
    ignore_errors: true
